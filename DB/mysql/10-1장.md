# 10-1장

# **10.1 통계 정보**

**Optimizer가 비용을 예측하는 핵심 재료**

## **10.1 통계 정보 개요**

- MySQL 옵티마이저가 실행 계획을 수립할 때 가장 중요한 요소가 **통계 정보**
- **MySQL 5.7 이전**: 테이블/인덱스의 개괄 정보 중심
- **MySQL 8.0**: 인덱스 없는 컬럼도 히스토그램(데이터 분포)을 저장 → 더 정교한 실행 계획 가능

---

## **10.1.1 테이블 및 인덱스 통계 정보**

- CBO(비용 기반 최적화)에서 통계는 실행 비용 예측의 핵심

### **10.1.1.1 통계 정보 저장 방식(휘발성 해결)**

- **5.6 이전**: 통계가 메모리에만 저장 → 재시작 시 사라짐(휘발성)
- **이후**: 통계를 시스템 테이블에 저장 → 영구 보관
    - innodb_index_stats
    - innodb_table_stats

### **인덱스 통계 정보 확인(예: employees)**

```sql
SELECT *
FROM innodb_index_stats
WHERE database_name='employees'
  AND table_name='employees';
```

- 주요 인덱스 통계 항목
    - stat_name='n_diff_pfx%' : 인덱스의 유니크 값 개수(카디널리티 관련)
    - stat_name='n_leaf_pages' : 리프 노드 페이지 개수
    - stat_name='size' : 인덱스 트리 전체 페이지 개수

### **테이블 통계 정보(innodb_table_stats) 주요 값**

- n_rows : 전체 레코드 수
- clustered_index_size : PK(클러스터드 인덱스) 크기(페이지 수)
- sum_of_other_index_sizes : PK 제외 인덱스 크기 합(페이지 수)

### **통계 정보 갱신 시점(대표)**

- 테이블이 새로 열릴 때
- 레코드가 대량 변경될 때(전체 레코드의 1/16 이상)
- ANALYZE TABLE
- SHOW TABLE STATUS, SHOW INDEX

### **주의**

- 통계가 갑자기 바뀌면 실행 계획이 달라져 성능 문제가 생길 수 있음
- 자동 갱신 제어
    - innodb_stats_auto_recalc = OFF → 자동 갱신 방지 가능
    - STATS_AUTO_RECALC 옵션으로 1(자동) / 0(수동) / DEFAULT

---

## **10.1.2 히스토그램(Histogram)**

### **배경**

- **5.7 이전**: 통계 부족 → 일부 페이지만 랜덤 참조 같은 방식으로 추정
- **8.0**: 컬럼의 데이터 분포(히스토그램) 저장 → 예측 정확도 향상

### **10.1.2.1 히스토그램 수집/삭제**

### **수집(컬럼 단위)**

```sql
ANALYZE TABLE employees UPDATE HISTOGRAM ON gender WITH 100 BUCKETS;
```

**종류(8.0)**

- **싱글톤(Singleton)**
    - 개별 값별 빈도 저장
    - 카디널리티 낮은 컬럼(중복 많음)에 적합
- **높이 균형(Equi-Height)**
    - 연속 값 범위를 “비슷한 빈도”가 되도록 구간 분할
    - 카디널리티 높은 컬럼(유니크 많음)에 적합

**삭제(딕셔너리만 삭제)**

```sql
ANALYZE TABLE employees DROP HISTOGRAM ON gender, hire_date;
```

- 테이블 데이터는 건드리지 않지만,
- 실행 계획이 달라질 수 있으니 주의

### **10.1.2.2 히스토그램 용도**

- 옵티마이저의 비용 예측 정확도 향상(데이터 분포 기반)
- 인덱스 없는 컬럼의 데이터 분포 파악
- 데이터 스큐(특정 값 쏠림) 파악
- 복합 인덱스 설계 시 컬럼 순서 결정에 도움

---

## **인덱스 다이브(Index Dive)와 관계**

- **인덱스 다이브**: 옵티마이저가 B-Tree를 직접 조사해 조건 일치 건수를 추정
    - 장점: 매우 정확
    - 단점: 비용(시간)이 큼, 대용량에서 부담 가능
- 히스토그램 vs 인덱스 다이브
    - 히스토그램: **빠른 추정(대략)**
    - 인덱스 다이브: **정확하지만 느림**
- MySQL 8.0부터 히스토그램으로 인덱스 없는 컬럼 분포까지 참고 가능 → 일부 인덱스 다이브를 대체/감소