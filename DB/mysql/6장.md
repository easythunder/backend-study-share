# 6장(데이터 압축)
---

## 📌 왜 데이터 압축이 필요한가

- 데이터 파일의 크기가 커지면 다음과 같은 문제가 발생할 수 있다:  
  - 쿼리를 처리하기 위해 읽어야 할 데이터 페이지가 많아져서, 더 많은 페이지가 버퍼 풀(buffer pool)에 적재됨 → 이로 인해 디스크로 더티 페이지(dirty page)가 자주 기록되어야 함 
  - 백업 및 복구 시간이 오래 걸림 
  - 디스크 공간(저장 비용) 증가 
- 따라서 많은 DBMS에서는 **데이터 압축** 기능을 제공하며, MySQL 도 예외가 아니다.
---

## 데이터 압축 방식: 페이지 압축 vs 테이블 압축

MySQL에서는 다음 두 가지 방식으로 데이터 압축을 지원한다.

| **페이지 압축 (Page Compression / Transparent Page Compression)** 
| 디스크에 저장할 때 각 데이터 페이지를 압축해서 저장하고, 읽어올 때 압축을 해제하는 방식 | + 디스크 사용 공간을 줄일 수 있음 – 하지만 운영체제(OS), 파일 시스템, 하드웨어가 특정 기능(`펀치 홀` / Punch-Hole)를 지원해야만 함. 지원이 안 되는 경우가 많아 실제로는 잘 사용되지 않음 |

| **테이블 압축 (Table Compression)** | 테이블 스페이스 단위로 압축을 적용한 테이블을 생성하는 방식. 운영체제나 하드웨어 제약 없이 사용 가능. | + 범용성이 높으며 실 사용 가능성이 큼 – 단점:  · 버퍼 풀(Buffer Pool)의 공간 활용 효율이 떨어짐. · 압축/압축 해제에 따른 CPU 오버헤드 → 쿼리 성능 저하 가능. · 데이터 변경이 빈번한 테이블은 압축률이 떨어질 수 있음.|

| **페이지 압축 (Page Compression / Transparent Page Compression)** 
| 디스크에 저장할 때 각 데이터 페이지를 압축해서 저장하고, 읽어올 때 압축을 해제하는 방식 | + 디스크 사용 공간을 줄일 수 있음 – 하지만 운영체제(OS), 파일 시스템, 하드웨어가 특정 기능(`펀치 홀` / Punch-Hole)를 지원해야만 함. 지원이 안 되는 경우가 많아 실제로는 잘 사용되지 않음 |

| **테이블 압축 (Table Compression)** | 테이블 스페이스 단위로 압축을 적용한 테이블을 생성하는 방식. 운영체제나 하드웨어 제약 없이 사용 가능. | + 범용성이 높으며 실 사용 가능성이 큼 – 단점:  · 버퍼 풀(Buffer Pool)의 공간 활용 효율이 떨어짐. · 압축/압축 해제에 따른 CPU 오버헤드 → 쿼리 성능 저하 가능. · 데이터 변경이 빈번한 테이블은 압축률이 떨어질 수 있음.|

Question?
테이블 압축을 운영 환경에서 도입한다면, 어떤 기준으로 결정할까?
Answer!
테이블 압축은 디스크를 아끼는 대신 CPU성능에 대한 리스크를 감수하는 선택입니다.
운영에서 그 교환이득이 맞는지 판단하는 기준은 아래와 같습니다.

1) 테이블 성격의 기준 : 읽기 위주? 혹은 쓰기(INSERT, UPDATE 등)이 많은지
2) 병목 기준 : 지금 문제가 디스크 용량인지 CPU인지
3) 성능 영향 기준 : 압축 후 CPU 증가/응답시간 악화가 허용 범위인지
4) 효과기준 : 압축률이 의미있게 나오는지
5) 운영리스크 기준 : 적용/롤백이 가능한지?

---

## 📄 페이지 압축 (Page Compression)

### 작동 원리

1. MySQL이 디스크에 쓸 데이터 페이지(예: 16 KB)를 압축한다.  
2. 예를 들어 압축 결과가 7 KB라고 가정하면, MySQL은 디스크에 7 KB를 기록한다. 
3. 이후 남는 9 KB 공간에 대해 **펀치 홀(punch hole)** 기능을 사용해 “빈 공간(sparse)”으로 표시하고, 해당 공간을 운영체제에 반환한다. 
4. 이렇게 하면 실제로는 7 KB만 디스크를 차지하지만, 파일 시스템 상에서는 원래 페이지 크기인 16 KB 페이지로 관리된다. 

### 제약 / 문제점

- 펀치 홀 기능은 단순히 OS 차원만 아니라 하드웨어, 파일 시스템 커널까지 지원해야 하며, 모든 환경에서 보장되지 않음. 
- 파일 복사나 백업 도구(예: `cp`, 백업 툴 등)를 사용할 때, 펀치 홀 공간이 채워져 원본 크기로 돌아갈 수 있음. 이 경우 압축의 의미가 없어짐. 
- 이러한 이유로 실제 운영 환경에서 페이지 압축을 사용하는 경우는 드물다. 

---

## 🗄️ 테이블 압축 (Table Compression)

### 적용 방법

- 압축 테이블을 사용하려면 별도의 **테이블 스페이스(table-per-table)** 가 필요하다. 즉, 시스템 변수 `innodb_file_per_table = ON` 상태여야 함. 
- 테이블 생성 시 아래와 같이 `ROW_FORMAT=COMPRESSED` 와 `KEY_BLOCK_SIZE` 옵션을 지정해야 한다. 

```sql
SET GLOBAL innodb_file_per_table = ON;

CREATE TABLE compressed_table (
    c1 INT PRIMARY KEY
)
ROW_FORMAT = COMPRESSED
KEY_BLOCK_SIZE = 8;
